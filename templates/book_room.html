<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Room {{ room.room_number }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/book_room.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/flash.css') }}">
</head>
<body>
    <div class="dashboard">
        <aside class="sidebar">
            <h2>User Dashboard</h2>
            <nav>
                <a href="{{ url_for('user_dashboard') }}">Dashboard</a>
                <a href="{{ url_for('my_bookings') }}">My Bookings</a>
                <a href="{{ url_for('user_profile') }}">Profile</a>
                <a href="{{ url_for('logout') }}" class="logout">Logout</a>
            </nav>
        </aside>

        <div class="booking-main">
            <div class="flash-container">
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                {% for category, message in messages %}
                <div class="flash-message {{ category }}">{{ message }}</div>
                {% endfor %}
                {% endif %}
                {% endwith %}
            </div>

            <div class="top-bar">
                <h1>Room Booking</h1>
                <a href="{{ url_for('user_dashboard') }}" class="back">Go Back</a>
            </div>

            <div class="container">
                <!-- Left Side: Room Preview -->
                <div class="room-card">
                    {% if room.image_path %}
                    <img src="{{ url_for('static', filename='uploads/rooms/' ~ room.image_path) }}" alt="Room" class="room-image">
                    {% else %}
                    <img src="https://via.placeholder.com/400x250/6366f1/ffffff?text=Room+{{ room.room_number }}" alt="Room" class="room-image">
                    {% endif %}

                    <div class="room-info">
                        <h2>Room {{ room.room_number }}</h2>
                        <p class="room-type"><b>{{ room.room_type_name }}</b> - {{ room.description }}</p>

                        <div class="price-tag">
                            <div class="price">Rs {{ "%.2f"|format(room.price_per_night|default(120)) }}</div>
                            <div class="per-night">per night</div>
                        </div>

                        <!-- Summary UI removed per request -->
                    </div>
                </div>

                <!-- Right Side: Booking Form -->
                <div class="form-card">
                    <form id="bookingForm">
                        <!-- Date Selection -->
                        <div class="section">
                            <h2>Select Dates</h2>
                            <div class="grid">
                                <div class="form-group">
                                    <label>Check-in Date *</label>
                                    <input type="date" id="checkin" required>
                                    <div class="note" id="checkin-note"></div>
                                </div>
                                <div class="form-group">
                                    <label>Check-out Date *</label>
                                    <input type="date" id="checkout" required>
                                    <div class="note" id="checkout-note"></div>
                                </div>
                                <div class="form-group full-width">
                                    <label>Unavailable Dates</label>
                                    <ul id="unavailable-list" class="unavailable-list">
                                        {% if unavailable_ranges and unavailable_ranges|length > 0 %}
                                            {% for r in unavailable_ranges %}
                                                <li>{{ r.start[:10] }} to {{ r.end[:10] }}</li>
                                            {% endfor %}
                                        {% else %}
                                            <li class="empty-state">No unavailable dates.</li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden calculation fields -->
                        <input type="hidden" id="weekend_nights" value="0">
                        <input type="hidden" id="week_nights" value="0">
                        <input type="hidden" id="lead_time" value="0">
                        <input type="hidden" id="arrival_year">
                        <input type="hidden" id="arrival_month">
                        <input type="hidden" id="arrival_date">
                        <input type="hidden" id="total_nights" value="0">
                        <input type="hidden" id="total_cost" value="0.00">

                        <!-- Guest Details -->
                        <div class="section">
                            <h2>Guest Information</h2>
                            <div class="grid">
                                <div class="form-group">
                                    <label>Number of Adults *</label>
                                    <input type="number" id="no_of_adults" min="1" max="6" value="2" required>
                                </div>
                                <div class="form-group">
                                    <label>Number of Children</label>
                                    <input type="number" id="no_of_children" min="0" max="4" value="0">
                                </div>
                            </div>
                        </div>

                        <!-- Preferences -->
                        <div class="section">
                            <h2>Preferences</h2>
                            <div class="grid">
                                <div class="form-group">
                                    <label>Meal Plan *</label>
                                    <select id="meal_plan_id" required>
                                        {% for m in meal_plans %}
                                        <option value="{{ m.meal_plan_id }}">{{ m.meal_plan_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Market Segment *</label>
                                    <select id="market_segment_id" required>
                                        {% for s in segments %}
                                        <!-- carry the human-readable name for client logic; backend still validates -->
                                        <option value="{{ s.market_segment_id }}" data-segment-name="{{ s.segment_name }}">{{ s.segment_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Special Requests</label>
                                    <input type="number" id="no_of_special_requests" min="0" max="5" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Car Parking</label>
                                    <select id="required_car_parking_space">
                                        <option value="0">Not Required</option>
                                        <option value="1">Required</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Dynamic Payment/Booking Section -->
                        <div class="payment-section">
                            <div class="total-preview">
                                <strong>Total: Rs <span id="display_total">0.00</span></strong>
                            </div>
                            <button type="button" class="btn-submit" id="bookButton" disabled>
                                <span id="button-text">Fill all fields</span>
                            </button>
                            <div class="payment-note" id="payment-note">
                                Select dates and preferences to continue.
                            </div>
                        </div>

                        <!-- Hidden fields for ML model / booking -->
                        <input type="hidden" id="repeated_guest" value="{{ repeated_guest }}">
                        <input type="hidden" id="no_of_previous_cancellations" value="{{ previous_cancellations }}">
                        <input type="hidden" id="no_of_previous_bookings_not_canceled" value="{{ previous_successful }}">
                        <input type="hidden" id="avg_price_per_room" value="{{ room.price_per_night|default(120) }}">
                        <input type="hidden" id="room_id" value="{{ room.room_id }}">
                        <input type="hidden" id="room_number" value="{{ room.room_number }}">
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const checkinInput = document.getElementById('checkin');
        const checkoutInput = document.getElementById('checkout');
        const marketSegmentSelect = document.getElementById('market_segment_id');
        const mealPlanSelect = document.getElementById('meal_plan_id');
        const bookButton = document.getElementById('bookButton');
        const buttonText = document.getElementById('button-text');
        const paymentNote = document.getElementById('payment-note');

        // Check if selected segment is Online (name comparison kept on a data attribute)
        function isOnlineSegment() {
            const opt = marketSegmentSelect.options[marketSegmentSelect.selectedIndex];
            return opt && opt.dataset.segmentName === 'Online';
        }

        // Date restrictions
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        checkinInput.min = todayStr;
        checkoutInput.min = todayStr;

        function updateSummary() {
            const checkin = checkinInput.value ? new Date(checkinInput.value) : null;
            const checkout = checkoutInput.value ? new Date(checkoutInput.value) : null;
            const price = parseFloat(document.getElementById('avg_price_per_room').value);

            if (!checkin || !checkout) {
                resetButton();
                return;
            }

            if (checkout <= checkin) {
                document.getElementById('checkout-note').textContent = 'Check-out must be after check-in';
                resetButton();
                return;
            } else {
                document.getElementById('checkout-note').textContent = '';
            }

            const oneDay = 24 * 60 * 60 * 1000;
            const nights = Math.round((checkout - checkin) / oneDay);

            let weekendCount = 0;
            let current = new Date(checkin);
            for (let i = 0; i < nights; i++) {
                if (current.getDay() === 5 || current.getDay() === 6) weekendCount++;
                current.setDate(current.getDate() + 1);
            }
            const weeknights = nights - weekendCount;

            const todayDate = new Date();
            todayDate.setHours(0, 0, 0, 0);
            const leadTime = Math.max(0, Math.round((checkin - todayDate) / oneDay));

            const totalAmount = (nights * price).toFixed(2);
            document.getElementById('display_total').textContent = totalAmount;
            document.getElementById('total_cost').value = totalAmount;
            document.getElementById('total_nights').value = nights;

            // Update hidden fields
            document.getElementById('weekend_nights').value = weekendCount;
            document.getElementById('week_nights').value = weeknights;
            document.getElementById('lead_time').value = leadTime;
            document.getElementById('arrival_year').value = checkin.getFullYear();
            document.getElementById('arrival_month').value = checkin.getMonth() + 1;
            document.getElementById('arrival_date').value = checkin.getDate();

            // Update booking button
            updateBookButton(totalAmount, nights);
        }

        function updateBookButton(totalAmount, nights) {
            if (nights > 0 && mealPlanSelect.value && marketSegmentSelect.value) {
                bookButton.disabled = false;

                if (isOnlineSegment()) {
                    // Online: initiate payment on backend and redirect to Khalti
                    buttonText.textContent = `Pay Rs ${totalAmount} with Khalti`;
                    paymentNote.textContent = "Secure payment via Khalti. Booking will be confirmed after successful payment.";
                } else {
                    // Offline: Instant booking
                    buttonText.textContent = `Book Room - Rs ${totalAmount}`;
                    paymentNote.textContent = "Payment will be handled at the hotel reception.";
                }
            } else {
                resetButton();
            }
        }

        function resetButton() {
            bookButton.disabled = true;
            buttonText.textContent = "Fill all required fields";
            paymentNote.textContent = "Select dates, meal plan, and market segment to continue.";
        }

        // Get complete booking data
        function getBookingData() {
            return {
                room_id: parseInt(document.getElementById('room_id').value),
                room_number: document.getElementById('room_number').value,
                avg_price_per_room: parseFloat(document.getElementById('avg_price_per_room').value),
                no_of_adults: parseInt(document.getElementById('no_of_adults').value),
                no_of_children: parseInt(document.getElementById('no_of_children').value || 0),
                no_of_weekend_nights: parseInt(document.getElementById('weekend_nights').value),
                no_of_week_nights: parseInt(document.getElementById('week_nights').value),
                lead_time: parseInt(document.getElementById('lead_time').value),
                arrival_year: parseInt(document.getElementById('arrival_year').value),
                arrival_month: parseInt(document.getElementById('arrival_month').value),
                arrival_date: parseInt(document.getElementById('arrival_date').value),
                total_nights: parseInt(document.getElementById('total_nights').value),
                total_guests: parseInt(document.getElementById('no_of_adults').value) + parseInt(document.getElementById('no_of_children').value || 0),
                no_of_special_requests: parseInt(document.getElementById('no_of_special_requests').value || 0),
                required_car_parking_space: parseInt(document.getElementById('required_car_parking_space').value || 0),
                meal_plan_id: parseInt(document.getElementById('meal_plan_id').value),
                market_segment_id: parseInt(document.getElementById('market_segment_id').value),
                repeated_guest: parseInt(document.getElementById('repeated_guest').value),
                no_of_previous_cancellations: parseInt(document.getElementById('no_of_previous_cancellations').value),
                no_of_previous_bookings_not_canceled: parseInt(document.getElementById('no_of_previous_bookings_not_canceled').value)
            };
        }

        // Show flash messages (client-side)
        function showMessage(message, category) {
            const flashDiv = document.createElement('div');
            flashDiv.className = `flash-message ${category}`;
            flashDiv.textContent = message;
            document.querySelector('.flash-container').appendChild(flashDiv);

            setTimeout(() => {
                flashDiv.style.transition = "opacity 0.5s ease";
                flashDiv.style.opacity = "0";
                setTimeout(() => flashDiv.remove(), 500);
            }, 4000);
        }

        // Book button handler
        bookButton.addEventListener('click', async (e) => {
            e.preventDefault();

            // If somehow still disabled, surface a clear hint
            if (bookButton.disabled) {
                showMessage("Please choose valid dates, meal plan, and market segment first.", "danger");
                return;
            }

            const totalAmount = parseFloat(document.getElementById('total_cost').value);
            const bookingData = getBookingData();

            if (isOnlineSegment()) {
                // ONLINE: create payment on backend and redirect to Khalti
                try {
                    bookButton.disabled = true;
                    buttonText.textContent = "Redirecting to Khalti...";
                    showMessage("Redirecting to payment gateway...", "info");

                    const response = await fetch('/api/khalti/create-payment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            amount: totalAmount,
                            booking_data: bookingData
                        })
                    });

                    let result = {};
                    try {
                        result = await response.json();
                    } catch (parseErr) {
                        console.error("Failed to parse payment response", parseErr);
                    }

                    if (response.ok && result.success && result.payment_url) {
                        window.location.href = result.payment_url;
                    } else {
                        showMessage(result.error || "Payment initiation failed.", "danger");
                        resetButton();
                    }
                } catch (error) {
                    console.error(error);
                    showMessage("Error initiating payment. Please try again.", "danger");
                    resetButton();
                }
            } else {
                // OFFLINE: Direct booking
                try {
                    bookButton.disabled = true;
                    buttonText.textContent = "Booking...";
                    showMessage("Creating booking...", "info");

                    const response = await fetch(`/book_room/{{ room.room_id }}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(bookingData)
                    });

                    const result = await response.json();
                    if (result.success) {
                        showMessage("Booking confirmed successfully!", "success");
                        setTimeout(() => window.location.href = '/user_dashboard', 1500);
                    } else {
                        showMessage(result.message || "Booking failed", "danger");
                        resetButton();
                    }
                } catch (error) {
                    console.error(error);
                    showMessage("Booking error. Please try again.", "danger");
                    resetButton();
                }
            }
        });

        // Event listeners
        checkinInput.addEventListener('change', updateSummary);
        checkoutInput.addEventListener('change', updateSummary);
        marketSegmentSelect.addEventListener('change', updateSummary);
        mealPlanSelect.addEventListener('change', updateSummary);

        // Auto-dismiss existing flashes
        document.querySelectorAll('.flash-message').forEach(msg => {
            setTimeout(() => {
                msg.style.transition = "opacity 0.5s ease";
                msg.style.opacity = "0";
                setTimeout(() => msg.remove(), 500);
            }, 3000);
        });

        updateSummary();
    </script>
</body>
</html>
